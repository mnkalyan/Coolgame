import hudson.*
import groovy.json.JsonOutput
import groovy.json.JsonSlurper

// Checkout Stage
def checkout() {
	stage ('Code Checkout') {
		cleanWs()
		checkout([$class: 'GitSCM', branches: [[name: '${BRANCH_NAME}']], extensions: [], userRemoteConfigs: [[credentialsId: '808beb4a-c1c0-4900-a3a3-2c4cdbcd876b', url: 'git@github.com:mnkalyan/Coolgame.git']]])
	}
}

// Build Stage
def build () {
    stage ('Build') {
		sh 'bash -xe cmake_build.sh'
    }
}

// Run Unit Tests
def runUnitTest() {
	stage ('Run Unit Test') {
		sh '''
			if [[ "${RUN_UNIT_TESTS}" == "true" ]]; then
				$WORKSPACE/build/CoolGame
				$WORKSPACE/build/runUnitTests
			fi
		'''
	}
}

// Archive Artifacts
def artifactsArchive() {
	stage ('Archive Artifacts') {
		archiveArtifacts artifacts: 'build/CoolGame*, build/runUnitTests*', followSymlinks: false
	}
}

//Call the above defined functions
node ("${env.NODE}") {
	checkout()
	build ()
	runUnitTest ()
	artifactsArchive ()
}